#!/bin/bash

# Colored output using https://stackoverflow.com/questions/5947742/how-to-change-the-output-color-of-echo-in-linux

CURRENT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
source "$CURRENT_DIR/common.sh"

usage() {
  echo "./install [-p] [-b] [-y]"
  echo "    -p : Don't update the path automatically"
  echo "    -b : Installed via homebrew"
  echo "    -y : Confirm install of ruby-build and openssl"
  exit 1
}

# Reads all options passed in and sets environment variables or shows usage/help
while getopts ":pby" opt; do
  case $opt in
    p ) SKIP_SETTING_PATH=1;;
    b ) INSTALLED_VIA_HOMEBREW=true;;
    y ) NO_PROMPTS=1;;
    * ) usage ;;
  esac
done

# Check if fastlane already exists
if [ -d "$FASTLANE_DIR" ]; then
  echoc "fastlane is already installed at $FASTLANE_DIR" yellow
fi

echoc "Installing fastlane to $FASTLANE_DIR..." yellow

# Copy helpers for keeping a clean execution environment
mkdir -p "$FASTLANE_DIR"
cp "$CURRENT_DIR/bundle-env" "$FASTLANE_DIR"
cp "$CURRENT_DIR/parse_env.rb" "$FASTLANE_DIR"

# Install bundler and fastlane
$FASTLANE_DIR/bundle-env gem install bundler --no-document --env-shebang
$FASTLANE_DIR/bundle-env gem install fastlane --no-document --env-shebang

# Copy the fastlane executable to run fastlane in the bundled environment
cp "$CURRENT_DIR/fastlane_shim" "$FASTLANE_DIR/fastlane"

echoc "Successfully installed fastlane to $FASTLANE_DIR" green
echo ""

# Update the contained fastlane install
reset_color
"$FASTLANE_DIR/fastlane" update_fastlane

if [ $? -ne 0 ]; then
  echoc "Failed to update fastlane after installing fastlane for unkown reason. This shouldn't have happened..." red
  exit 1
fi

manual_installation() {
  echoc "Please add the following line to your $shell profile:" yellow
  set_color cyan
  echo -e "$1"
  reset_color
  echoc "After doing so close the terminal session and restart it to start using fastlane  ðŸš€" green
}

# check if it's already in the user's path
echo $PATH | grep -o $FASTLANE_DIR > /dev/null
if [ $? -ne 0 ]; then
  export LINE_TO_ADD="\nexport PATH=\"$FASTLANE_DIR_RAW:\$PATH\"\n"

  if [[ "$shell" == "fish" ]]; then
    LINE_TO_ADD="set -x PATH $FASTLANE_DIR_RAW \$PATH" # fish has its own way of setting variables
  fi

  if [ -f $profile_expanded ]; then
    echoc "Detected shell config file at path '$profile'" yellow

    if [ "$SKIP_SETTING_PATH" == "1" ]; then
      manual_installation "$LINE_TO_ADD"
      exit 0
    fi

    echoc "We can add the following line to your shell config" yellow
    echoc "so you can run fastlane from any directory on your machine" yellow
    set_color cyan
    echo -e "$LINE_TO_ADD"
    reset_color

    if [ "$NO_PROMPTS" == "1" ]; then
      echo ""
      echo -e $LINE_TO_ADD >> $profile_expanded
      echoc "Successfully updated $profile" green
      echoc "Please close the terminal session and restart it to start using fastlane ðŸš€" green
    else
      set_color yellow
      read -p "Do you want fastlane to add itself to the PATH by updating your profile? (y/n) " -n 1 choice
      reset_color
      case "$choice" in
        y|Y )
          echo ""
          echo -e $LINE_TO_ADD >> $profile_expanded
          echoc "Successfully updated $profile" green
          echoc "Please close the terminal session and restart it to start using fastlane ðŸš€" green
      ;;
        * )
          echo ""
          manual_installation "$LINE_TO_ADD"
      ;;
      esac
    fi
  else
    echoc "Couldn't detect shell config file ($shell - $profile)" red
    manual_installation "$LINE_TO_ADD"
  fi
else
  echoc "Detected fastlane is already in your path ðŸš€" green
fi